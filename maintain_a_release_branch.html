<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>PerfWatcher</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
	<link rel="icon" type="image/ico" href="images/perfwatcher.ico">
    <script src="javascripts/scale.fix.js"></script>
	<script type="text/javascript">
	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-31597873-1']);
	  _gaq.push(['_setDomainName', 'perfwatcher.org']);
	  _gaq.push(['_trackPageview']);
	  (function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();
	</script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1><a href="index.html">PerfWatcher</a></h1>
        <p>Performance Monitoring based on Collectd</p>
        <p class="view"><a href="http://github.com/perfwatcher/perfwatcher">View the Project on GitHub <small>perfwatcher/perfwatcher</small></a></p>
        <ul>
          <li><a href="download.html">Quick<strong>Download</strong></a></li>
          <li><a href="http://github.com/perfwatcher/perfwatcher" target="_new">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>

<h3>Maintain a release branch of collectd-pw in Git</h3>

<h4>Create a new branch from upstream</h4>

<p>A new version is released upstream. We will merge it.</p>
<p><u>WARNING</u> : this will delete all files in your current repository (if not saved in a branch)</p>

<p>First, create a new and empty branch. Then merge collectd from upstream (one commit for all : --squash) and tag it.</p>
<pre>
# Create the empty branch
  $ git symbolic-ref HEAD refs/head/newempty
  $ rm .git/index
# The following will remove all the files in your path
  $ git clean -fdx
# Commit the new branch with a new file inside and with its name
  $ echo "2012-11-15 version 5.1.1" &gt; ChangeLog-collectd_pw
  $ git add ChangeLog-collectd_pw
  $ git commit -m "Initial commit for release/5.1.1 branch"
# Checkout the new branch
  $ git checkout -b release/5.1.1
# Merge collectd from upstream
  $ git merge --squash upstream/collectd-5.1
# Commit and tag the merge
  $ git commit -a -m "Merge upstream/collectd-5.1 branch"
  $ git tag -a "collectd-5.1.1-upstream" -m "Version 5.1.1 from git branch collectd-5.1 on collectd/collectd"
</pre>

<p>Clean, build, make some basic checks before pushing on perfwatcher repo</p>

<pre>
$ git push -n origin release/5.1.1
$ git push origin release/5.1.1
</pre>

<pre>
$ git push -n origin refs/tags/collectd-5.1.1-upstream
$ git push origin refs/tags/collectd-5.1.1-upstream
</pre>

<p><u>WARNING</u> : first <code>git push -n</code> to check that you do not push unwanted stuff (like unwanted tags - it happened to me)</p>

<p>Note : if you have an error <code>RPC failed; result=56</code>..., edit your git config (<code>git config</code> or <code>vi ~/.gitconfig</code>) and set the <code>http.postbuffer</code> variable to something bigger (<code>http.postbuffer=5M</code> for release/5.1.1)</p>

<h4>Make a patch file from a branch</h4>

<p>Note : this is useful when trying to apply patches from a version to another</p>

<pre>
$ git checkout patch-fix_make_distcheck/5.1.1
$ git format-patch collectd-5.1.1-upstream
</pre>

<p>This will go the the branch containing the patch. Then it will create patch files (one per commit in the branch) since the beginning (here, the beginning is the tag <code>collectd-5.1.1-upstream</code>).


<h4>Maintain a patch</h4>

<p>Note : the following is an example with the patch <i>fix_make_distcheck</i>.</p>

<p>1/ First patch (or moving patch from one release to another)</p>
<pre>
$ git checkout release/5.1.1
$ git checkout -b patch-fix_make_distcheck/5.1.1 refs/tags/collectd-5.1.1-upstream
$ git push -u origin patch-fix_make_distcheck/5.1.1
</pre>

<p>1/ Next times, only go to that branch</p>
<pre>
$ git checkout patch-fix_make_distcheck/5.1.1
</pre>

<p>2/ Then work on the patch.</p>
<p>3/ Then commit</p>

<pre>
$ git status
$ git add &lt;file1&gt; &lt;file2&gt;...
$ git commit -a
</pre>

<p>4/ Apply the patch : merge it on the main branch (<i>release/x.y</i>) </p>

<pre>
$ git checkout release/5.1.1
$ git merge patch-fix_make_distcheck/5.1.1
</pre>

<h4>Release a collectd-pw new version</h4>
<p>Yes, there is not a lot of fun here</p>
<ul>
<li>Edit ChangeLog-collectd_pw</li>
<li>run the following :</li>
</ul>
<pre>
$ ./clean.sh
$ ./build.sh
$ ./configure --enable-debug
$ make
$ make distcheck
</pre>
<ul>
<li>Test the generated package (something like <i>collectd-5.1.1.upstream.29.g2875a48.tar.gz</i>. Well, it should be working because the only thing we change here is ChangeLog-collectd-pw. However, it's better to check again.</li>
<li>Commit the modification on ChangeLog-collectd_pw</li>
</ul>
<pre>
$ git commit -a -m "New release 20121115"
</pre>
<ul>
<li>Tag the new release</li>
</ul>
<pre>
$ git tag -a "collectd-5.1.1-20121115" -m "Unofficial version 5.1.1-20121115 with perfwatcher patches"
</pre>
<ul>
<li>Make the new tar.gz file. Run the following (again) :</li>
</ul>
<pre>
$ ./clean.sh
$ ./build.sh
$ ./configure
$ make distcheck
</pre>
<ul>
<li>You should now have archives like <i>collectd-5.1.1.20121115</i> (you recognize the tag).</li>
<li>Push the branch upstream (check first and don't upload unwanted stuff - don't upload unwanted tags)</li>
</ul>
<pre>
$ git push -u -n
$ git push -u
$ git push -u -n origin refs/tags/collectd-5.1.1-20121115
$ git push -u origin refs/tags/collectd-5.1.1-20121115
</pre>
<ul>
<li>Upload the files</li>
<li>Update the web site</li>
<ul>
  <li>Update <code>genpages.sh</code> (change the version number)</li>
  <li>Update the compatibility matrix</li>
  <li>Run <code>genpages.sh</code></li>
  <li><code>git commit</code></li>
  <li><code>git push</code></li>
</ul>
</ul>
      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="http://github.com/feraudet">Cyril Feraudet</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="http://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
    
  </body>
</html>

